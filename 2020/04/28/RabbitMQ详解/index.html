<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="rabbitmq," />










<meta name="description" content="前言     消息队列(Message Queue，简称MQ)现在在很多公司都有使用，而MQ框架非常之多，比较流行的有RabbitMq、ActiveMq、ZeroMq、kafka，以及阿里开源的RocketMQ，巧了，我们公司使用的是RabbitMq，所以本文主要介绍一下RabbitMq（[捂脸]其实是我不会其他MQ，日后学了会再发的），主要从以下几点来讲： 1、RabbitMq的安装 2、Sp">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ详解">
<meta property="og:url" content="http://yoursite.com/2020/04/28/RabbitMQ%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="少年肩头">
<meta property="og:description" content="前言     消息队列(Message Queue，简称MQ)现在在很多公司都有使用，而MQ框架非常之多，比较流行的有RabbitMq、ActiveMq、ZeroMq、kafka，以及阿里开源的RocketMQ，巧了，我们公司使用的是RabbitMq，所以本文主要介绍一下RabbitMq（[捂脸]其实是我不会其他MQ，日后学了会再发的），主要从以下几点来讲： 1、RabbitMq的安装 2、Sp">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/17159db8e22c6f23?w=1021&h=514&f=png&s=299165">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/1715a51873ee648d">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/17159ff65b0ab2ec?w=2236&h=1236&f=png&s=224712">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/1715a070c9003b96?w=1638&h=1024&f=png&s=1046965">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/1715a260ee0bde3f?w=1134&h=714&f=png&s=518034">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/1715a309d9381810?w=1638&h=994&f=png&s=967061">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/1715a340d977421b?w=3524&h=1418&f=png&s=270688">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/1715a3adfe4be394?w=3580&h=1296&f=png&s=387650">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/1715a3d51f4b7421?w=2056&h=1314&f=png&s=169104">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/1715a44be06cc787?w=1850&h=1748&f=png&s=175351">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/8/1715a469a1fe44ce?w=2084&h=1282&f=png&s=157835">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715eebb52ce720a?w=1014&h=551&f=png&s=97505">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715ef4191f6ce90?w=634&h=404&f=png&s=33809">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715efddfabd64d9?w=949&h=367&f=png&s=45932">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f5306ea0a482?w=1932&h=522&f=png&s=91486">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f5598dd3fdb5?w=2636&h=198&f=png&s=124671">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f5717f0702b2?w=1808&h=738&f=png&s=93414">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f5d3f7db9091?w=3356&h=636&f=png&s=336057">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f63bf2d87e97?w=375&h=165&f=png&s=18461">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f774fdf41421?w=2476&h=726&f=png&s=220685">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f77a7cc9858b?w=1738&h=696&f=png&s=161784">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f86d47012a13?w=1096&h=652&f=png&s=81937">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f87a8ccdfe82?w=1340&h=622&f=png&s=76593">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f89729a689e6?w=1716&h=1090&f=png&s=251965">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f8a48bf2b653?w=2052&h=626&f=png&s=207530">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/9/1715f8b5a02ac1c3?w=478&h=190&f=png&s=14537">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/13/171718c1486f59a9?w=1067&h=831&f=png&s=146714">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/13/171718ebe5b4cce6?w=783&h=339&f=png&s=50877">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17167e86578fa14a?w=882&h=602&f=png&s=58162">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/10/171647947d66f4f2?w=1168&h=1124&f=png&s=137900">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/10/171647b496c028a4?w=1908&h=478&f=png&s=72390">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17167e5a64e6d38f?w=1320&h=133&f=png&s=46243">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17167e5e3d2d9f31?w=685&h=89&f=png&s=5471">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17167eae9800307b?w=1109&h=327&f=png&s=79066">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/171681fd68e6505a?w=671&h=489&f=png&s=45219">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/13/171719912fff7d45?w=820&h=338&f=png&s=56285">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/13/1717199b3fd2ce2a?w=742&h=339&f=png&s=55681">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/1716841b457fd435?w=855&h=618&f=png&s=54896">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/1716842cdedc1203?w=1924&h=268&f=png&s=42474">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168435d0169584?w=1367&h=152&f=png&s=53082">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/1716843b9d8c3127?w=757&h=101&f=png&s=6926">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/171684467709149b?w=1932&h=288&f=png&s=43952">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/1716845ebeaa8578?w=1397&h=145&f=png&s=51673">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168465a8b29e9d?w=1006&h=158&f=png&s=3948">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/171684777b35d6f3?w=1087&h=107&f=png&s=15567">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/171686ae3908bc61?w=549&h=295&f=png&s=52074">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168479ab8366b1?w=1040&h=267&f=png&s=69803">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/13/171719c400870baf?w=773&h=349&f=png&s=57454">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/13/171719d99946425c?w=815&h=347&f=png&s=58176">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/1716870bcae58b4e?w=845&h=596&f=png&s=50036">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168711b5ae4faa?w=1926&h=250&f=png&s=41016">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168718a5090f21?w=1345&h=129&f=png&s=48518">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/1716871c94b7aab5?w=760&h=112&f=png&s=6913">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/1716873cbda6bd97?w=1930&h=282&f=png&s=44314">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/171687425021c5f0?w=1345&h=148&f=png&s=49312">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168746319283aa?w=1119&h=166&f=png&s=4505">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168abd0127a6f5?w=987&h=795&f=png&s=117175">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168ac009cbb9c8?w=958&h=658&f=png&s=100784">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168ad966e67126?w=1056&h=466&f=png&s=36098">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168adcb956f594?w=875&h=556&f=png&s=42866">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168b0251ebf635?w=1910&h=312&f=png&s=48066">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168b0e2f78ce6f?w=1346&h=211&f=png&s=80519">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716ca336fae5e9e?w=839&h=525&f=png&s=67754">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/13/17171a8df2d42feb?w=718&h=352&f=png&s=51446">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716ca3a15ae07db?w=936&h=400&f=png&s=70492">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716ca3f0186d593?w=419&h=274&f=png&s=26357">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/13/17171aac89448dec?w=784&h=509&f=png&s=91246">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716cb499490d255?w=979&h=386&f=png&s=73985">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716cb56873cdb95?w=1344&h=133&f=png&s=65949">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716d0a5bddc4b72?w=735&h=523&f=png&s=63330">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716d21521b76325?w=1044&h=805&f=png&s=126751">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716d0bde6e67f5e?w=1186&h=915&f=png&s=169954">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716d0cf043c196b?w=942&h=388&f=png&s=59120">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716d0e4cb75674e?w=1405&h=251&f=png&s=72402">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/13/17171afbdf8d933c?w=986&h=704&f=png&s=115516">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716c92a6abaf550?w=897&h=670&f=png&s=92535">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716c961c02c0a9b?w=1380&h=218&f=png&s=106308">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716c97e28f0425a?w=1475&h=279&f=png&s=104494">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/11/17168b84a1ed1f5b?w=675&h=588&f=png&s=202743">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716d22cb98cfb27?w=561&h=327&f=png&s=109217">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/4/12/1716d4e213332f33?w=1200&h=418&f=png&s=211004">
<meta property="article:published_time" content="2020-04-28T08:27:00.000Z">
<meta property="article:modified_time" content="2020-04-29T02:48:43.174Z">
<meta property="article:author" content="wanxi">
<meta property="article:tag" content="rabbitmq">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2020/4/8/17159db8e22c6f23?w=1021&h=514&f=png&s=299165">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/04/28/RabbitMQ详解/"/>





  <title>RabbitMQ详解 | 少年肩头</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/weiwanx" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">少年肩头</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/28/RabbitMQ%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wanxi">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="少年肩头">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RabbitMQ详解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-28T16:27:00+08:00">
                2020-04-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index">
                    <span itemprop="name">中间件</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="https://user-gold-cdn.xitu.io/2020/4/8/17159db8e22c6f23?w=1021&h=514&f=png&s=299165" alt=""></p>
<center><font color=DeepSkyBlue Size=5>前言</font></center>

<hr>
<p>  消息队列(Message Queue，简称MQ)现在在很多公司都有使用，而MQ框架非常之多，比较流行的有RabbitMq、ActiveMq、ZeroMq、kafka，以及阿里开源的RocketMQ，巧了，我们公司使用的是RabbitMq，所以本文主要介绍一下RabbitMq（[捂脸]其实是我不会其他MQ，日后学了会再发的），主要从以下几点来讲：</p>
<p>1、RabbitMq的安装 <br/><br>2、SpringBoot项目中RabbitMq的使用 (五种模式) <br/><br>3、延迟队列 <br/><br>4、RabbitMq使用过程中遇到的问题及解决方案（如消息重试机制，消息重复消费、消息丢失、消息的顺序消费等等）<br/></p>
<p><font color=DeepSkyBlue Size=5>原创不易，最后希望各位看官爸爸动动手点个赞吧！</font></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/8/1715a51873ee648d" alt=""></p>
<center><font color=DeepSkyBlue Size=5>正文</font></center>


<h1 id="Mac下RabbitMq的安装（windows安装点这里）"><a href="#Mac下RabbitMq的安装（windows安装点这里）" class="headerlink" title="Mac下RabbitMq的安装（windows安装点这里）"></a>Mac下RabbitMq的安装（<a href="https://juejin.im/post/5cb597d06fb9a0688f375fd1" target="_blank" rel="noopener">windows安装点这里</a>）</h1><hr>
<h2 id="安装Homebrew"><a href="#安装Homebrew" class="headerlink" title="安装Homebrew"></a>安装Homebrew</h2><p>1、进入<a href="https://brew.sh/index_zh-cn.html" target="_blank" rel="noopener">Homebrew官网</a>，复制命令：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/8/17159ff65b0ab2ec?w=2236&h=1236&f=png&s=224712" alt=""></p>
<p>2、打开电脑中端，将命令粘贴至中端并按回车键执行，等待安装完成：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/8/1715a070c9003b96?w=1638&h=1024&f=png&s=1046965" alt=""></p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>1、如果出现粘贴命令回车之后出现<font color=red>curl: (7) Failed to connect to raw.githubusercontent.com port 443: Connection refused</font>这样的提示，<font color=DeepSkyBlue>请连接手机热点再次尝试</font>，如果还不行<a href="http://www.mabiji.com/mac/brew-curl-failed.html" target="_blank" rel="noopener">请点击此处</a>。<br/></p>
<h2 id="安装RabbitMq"><a href="#安装RabbitMq" class="headerlink" title="安装RabbitMq"></a>安装RabbitMq</h2><p>1、打开终端，输入如下命令：brew install rabbitmq，点击回车键等待安装，看到如下界面即为成功：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/8/1715a260ee0bde3f?w=1134&h=714&f=png&s=518034" alt=""></p>
<h2 id="启动RabbitMq"><a href="#启动RabbitMq" class="headerlink" title="启动RabbitMq"></a>启动RabbitMq</h2><p>1、在安装完成之后在中端输入如下内容即可启动，看到如图4步骤即为启动成功（启动成功之后别关闭中端，不然登陆浏览器是看不到的）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、cd /usr/local/Cellar/rabbitmq/</span><br><span class="line"><span class="number">2</span>、cd <span class="number">3.8</span><span class="number">.3</span>（版本号看你自己的是多少）</span><br><span class="line"><span class="number">3</span>、sbin/rabbitmq-server</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/4/8/1715a309d9381810?w=1638&h=994&f=png&s=967061" alt=""></p>
<p>2、登录浏览器 <a href="http://localhost:15672" target="_blank" rel="noopener">http://localhost:15672</a> 进行查看 初始化默认密码都为<font color=DeepSkyBlue>guest/guest</font></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/8/1715a340d977421b?w=3524&h=1418&f=png&s=270688" alt=""></p>
<h2 id="添加用户及授权"><a href="#添加用户及授权" class="headerlink" title="添加用户及授权"></a>添加用户及授权</h2><h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><p><img src="https://user-gold-cdn.xitu.io/2020/4/8/1715a3adfe4be394?w=3580&h=1296&f=png&s=387650" alt=""></p>
<p>(1)、超级管理员(administrator)</p>
<p>可登陆管理控制台，可查看所有的信息，并且可以对用户，策略(policy)进行操作。</p>
<p>(2)、监控者(monitoring)</p>
<p>可登陆管理控制台，同时可以查看rabbitmq节点的相关信息(进程数，内存使用情况，磁盘使用情况等)</p>
<p>(3)、策略制定者(policymaker)</p>
<p>可登陆管理控制台, 同时可以对policy进行管理。但无法查看节点的相关信息(上图红框标识的部分)。</p>
<p>(4)、普通管理者(management)</p>
<p>仅可登陆管理控制台，无法看到节点信息，也无法对策略进行管理。</p>
<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p><img src="https://user-gold-cdn.xitu.io/2020/4/8/1715a3d51f4b7421?w=2056&h=1314&f=png&s=169104" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/8/1715a44be06cc787?w=1850&h=1748&f=png&s=175351" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/8/1715a469a1fe44ce?w=2084&h=1282&f=png&s=157835" alt=""></p>
<p>RabbitMq默认virtual host为 <font color=red>/</font>， 如果想自定义virtual host，<a href="https://www.jianshu.com/p/8bc5d25855e8" target="_blank" rel="noopener">请点击这里</a>。</p>
<h1 id="SpringBoot项目中RabbitMq的使用"><a href="#SpringBoot项目中RabbitMq的使用" class="headerlink" title="SpringBoot项目中RabbitMq的使用"></a>SpringBoot项目中RabbitMq的使用</h1><hr>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715eebb52ce720a?w=1014&h=551&f=png&s=97505" alt=""></p>
<h2 id="配置项目"><a href="#配置项目" class="headerlink" title="配置项目"></a>配置项目</h2><h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    host: 自己rabbit的路径</span><br><span class="line">    port: 自己rabbit的端口</span><br><span class="line">    virtual-host: /</span><br><span class="line">    username: 自己rabbit的账号</span><br><span class="line">    password: 自己rabbit的密码</span><br><span class="line">    publisher-confirms: <span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<h3 id="项目下新建rabbit包，内容可直接复制粘贴过去"><a href="#项目下新建rabbit包，内容可直接复制粘贴过去" class="headerlink" title="项目下新建rabbit包，内容可直接复制粘贴过去"></a>项目下新建rabbit包，内容可直接复制粘贴过去</h3><p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715ef4191f6ce90?w=634&h=404&f=png&s=33809" alt=""></p>
<p>1、增加获取配置文件信息的实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * rabbitmq 服务器地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.rabbitmq.host&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * rabbitmq 服务器端口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.rabbitmq.port&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * rabbitmq 账号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.rabbitmq.username&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * rabbitmq 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.rabbitmq.password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、增加配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitProperties rabbitProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">connectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CachingConnectionFactory connectionFactory = <span class="keyword">new</span> CachingConnectionFactory(rabbitProperties.getHost(), rabbitProperties.getPort());</span><br><span class="line">        connectionFactory.setUsername(rabbitProperties.getUsername());</span><br><span class="line">        connectionFactory.setPassword(rabbitProperties.getPassword());</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">"/"</span>);</span><br><span class="line">        connectionFactory.setPublisherConfirms(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> connectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scope</span>(value=ConfigurableBeanFactory.SCOPE_PROTOTYPE)这个是说在每次注入的时候回自动创建一个新的bean实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scope</span>(value=ConfigurableBeanFactory.SCOPE_SINGLETON)单例模式，在整个应用中只能创建一个实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scope</span>(value=WebApplicationContext.SCOPE_GLOBAL_SESSION)全局session中的一般不常用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scope</span>(value=WebApplicationContext.SCOPE_APPLICATION)在一个web应用中只创建一个实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scope</span>(value=WebApplicationContext.SCOPE_REQUEST)在一个请求中创建一个实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Scope</span>(value=WebApplicationContext.SCOPE_SESSION)每次创建一个会话中创建一个实例</span></span><br><span class="line"><span class="comment">     * proxyMode=ScopedProxyMode.INTERFACES创建一个JDK代理模式</span></span><br><span class="line"><span class="comment">     * proxyMode=ScopedProxyMode.TARGET_CLASS基于类的代理模式</span></span><br><span class="line"><span class="comment">     * proxyMode=ScopedProxyMode.NO（默认）不进行代理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope</span>(ConfigurableBeanFactory.SCOPE_SINGLETON)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RabbitTemplate <span class="title">rabbitTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RabbitTemplate template = <span class="keyword">new</span> RabbitTemplate(connectionFactory());</span><br><span class="line">        <span class="comment">// 消息发送失败返回到队列中, yml需要配置 publisher-returns: true</span></span><br><span class="line">        <span class="comment">// template.setMandatory(true);</span></span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、定义队列、交换器等名称（这里有新增了订单相关队列和交换器）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMqKey</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单-队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_ORDER_QUEUE = <span class="string">"trade-order-queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单-交换器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_ORDER_EXCHANGE = <span class="string">"trade-order-exchange"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、初始化队列、交换器等并绑定关系</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TradeOrderQueueConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(TradeOrderQueueConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建队列</span></span><br><span class="line"><span class="comment">     * Queue 可以有4个参数</span></span><br><span class="line"><span class="comment">     * String name: 队列名</span></span><br><span class="line"><span class="comment">     * boolean durable: 持久化消息队列，rabbitmq 重启的时候不需要创建新的队列，默认为 true</span></span><br><span class="line"><span class="comment">     * boolean exclusive: 表示该消息队列是否只在当前的connection生效，默认为 false</span></span><br><span class="line"><span class="comment">     * boolean autoDelete: 表示消息队列在没有使用时将自动被删除，默认为 false</span></span><br><span class="line"><span class="comment">     * Map&lt;String, Object&gt; arguments:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"queue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">queue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"queue : &#123;&#125;"</span>, RabbitMqKey.TRADE_ORDER_QUEUE);</span><br><span class="line">        <span class="comment">// 队列持久化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(RabbitMqKey.TRADE_ORDER_QUEUE, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个 Fanout 类型的交换器</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * rabbitmq中，Exchange 有4个类型：Direct，Topic，Fanout，Headers</span></span><br><span class="line"><span class="comment">     * Direct Exchange：将消息中的Routing key与该Exchange关联的所有Binding中的Routing key进行比较，如果相等，则发送到该Binding对应的Queue中；</span></span><br><span class="line"><span class="comment">     * Topic Exchange：将消息中的Routing key与该Exchange关联的所有Binding中的Routing key进行对比，如果匹配上了，则发送到该Binding对应的Queue中；</span></span><br><span class="line"><span class="comment">     * Fanout Exchange：直接将消息转发到所有binding的对应queue中，这种exchange在路由转发的时候，忽略Routing key；</span></span><br><span class="line"><span class="comment">     * Headers Exchange：将消息中的headers与该Exchange相关联的所有Binging中的参数进行匹配，如果匹配上了，则发送到该Binding对应的Queue中；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"fanoutExchange"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> FanoutExchange <span class="title">fanoutExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"exchange : &#123;&#125;"</span>, RabbitMqKey.TRADE_ORDER_EXCHANGE);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FanoutExchange(RabbitMqKey.TRADE_ORDER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把队列（Queue）绑定到交换器（Exchange）</span></span><br><span class="line"><span class="comment">     * topic 使用路由键（routingKey）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">Binding <span class="title">fanoutBinding</span><span class="params">(@Qualifier(<span class="string">"queue"</span>)</span> Queue queue,</span></span><br><span class="line"><span class="function">                    @<span class="title">Qualifier</span><span class="params">(<span class="string">"fanoutExchange"</span>)</span> FanoutExchange fanoutExchange) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、发送消息类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果rabbitTemplate的scope属性设置为ConfigurableBeanFactory.SCOPE_PROTOTYPE，所以不能自动注入</span></span><br><span class="line"><span class="comment">     * 需手动注入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单信息（发送至交换器）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">orderSendExchange</span><span class="params">(Object payload)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> baseSend(RabbitMqKey.TRADE_ORDER_EXCHANGE, <span class="string">""</span>, payload, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单信息（发送至队列）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">orderSendQueue</span><span class="params">(Object payload)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> baseSend(<span class="string">""</span>, RabbitMqKey.TRADE_ORDER_QUEUE, payload, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * MQ 发送数据基础方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange  交换器名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey  队列名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload 消息信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uniqueMessageId  标示id，不传可自动生成</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> messageExpirationTime  持久化时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 消息编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">baseSend</span><span class="params">(String exchange, String routingKey, Object payload, String uniqueMessageId, Long messageExpirationTime)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 生成消息ID</span></span><br><span class="line">        String finalUniqueMessageId = uniqueMessageId;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(uniqueMessageId)) &#123;</span><br><span class="line">            uniqueMessageId = UUID.randomUUID().toString();</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">"SEND --- unique message id：&#123;&#125;"</span>, uniqueMessageId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消息属性</span></span><br><span class="line">        MessagePostProcessor messagePostProcessor = <span class="keyword">new</span> MessagePostProcessor() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Message <span class="title">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException </span>&#123;</span><br><span class="line">                <span class="comment">// 消息属性中写入消息编号</span></span><br><span class="line">                message.getMessageProperties().setMessageId(finalUniqueMessageId);</span><br><span class="line">                <span class="comment">// 消息持久化时间</span></span><br><span class="line">                <span class="keyword">if</span> (!StringUtils.isEmpty(String.valueOf(messageExpirationTime))) &#123;</span><br><span class="line">                    logger.info(<span class="string">"设置消息持久化时间：&#123;&#125;"</span>, messageExpirationTime);</span><br><span class="line">                    message.getMessageProperties().setExpiration(Long.toString(messageExpirationTime));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 设置持久化模式</span></span><br><span class="line">                message.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"SEND --- messagePostProcessor：&#123;&#125;"</span>, messagePostProcessor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 消息</span></span><br><span class="line">        Message message = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">            String json = objectMapper.writeValueAsString(payload);</span><br><span class="line">            logger.info(<span class="string">"发送消息：&#123;&#125;"</span>, payload.toString());</span><br><span class="line">            <span class="comment">// 转换数据格式</span></span><br><span class="line">            MessageProperties messageProperties = <span class="keyword">new</span> MessageProperties();</span><br><span class="line">            messageProperties.setContentEncoding(MessageProperties.CONTENT_TYPE_JSON);</span><br><span class="line">            message = <span class="keyword">new</span> Message(json.getBytes(), messageProperties);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// correlationData</span></span><br><span class="line">        CorrelationData correlationData = <span class="keyword">new</span> CorrelationData(uniqueMessageId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * convertAndSend(String exchange, String routingKey, Object message, MessagePostProcessor messagePostProcessor, CorrelationData correlationData)</span></span><br><span class="line"><span class="comment">         * exchange: 路由</span></span><br><span class="line"><span class="comment">         * routingKey: 绑定key</span></span><br><span class="line"><span class="comment">         * message: 发送消息</span></span><br><span class="line"><span class="comment">         * messagePostProcessor: 消息属性处理类</span></span><br><span class="line"><span class="comment">         * correlationData: 对象内部只有一个 id 属性，用来表示当前消息唯一性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rabbitTemplate.convertAndSend(exchange, routingKey, message, messagePostProcessor, correlationData);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> finalUniqueMessageId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6、确认信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitAck</span> <span class="keyword">implements</span> <span class="title">RabbitTemplate</span>.<span class="title">ConfirmCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(RabbitAck<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//指定 ConfirmCallback</span></span><br><span class="line">        <span class="comment">//rabbitTemplate如果为单例的话，那回调就是最后设置的内容</span></span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ack</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">confirm</span><span class="params">(CorrelationData correlationData, <span class="keyword">boolean</span> ack, String cause)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"ACK --- MQ message id: &#123;&#125;"</span> + correlationData);</span><br><span class="line">        <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">            logger.info(<span class="string">"ACK --- Message sent confirmation success！"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"ACK --- MQ message id: &#123;&#125;"</span>, correlationData.getId());</span><br><span class="line">            logger.info(<span class="string">"ACK --- MQ confirmetion: &#123;&#125;"</span>, ack);</span><br><span class="line">            logger.info(<span class="string">"ACK --- Message sending confirmation failed, reason for failure:"</span> + cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="1、简单队列"><a href="#1、简单队列" class="headerlink" title="1、简单队列"></a>1、简单队列</h3><p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715efddfabd64d9?w=949&h=367&f=png&s=45932" alt=""></p>
<p>p:消息生产者（就是寄信的人）<br/><br>c:消息消费者（就是收信的人）<br/><br>红色格子: 队列（就是邮差，送信的人）<br/></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">发送至队列的消息只会被一个消费者获取然后消费，要想多个消费者同时接收消费请看后面的内容！</span><br></pre></td></tr></table></figure>

<p>1、发送消息</p>
<p>（1） 新增发送消息接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProducersController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Sender sender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/producers"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">producers</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sender.orderSendQueue(<span class="string">"Hello World"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）PostMan调用接口</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f5306ea0a482?w=1932&h=522&f=png&s=91486" alt=""></p>
<p>（3）查看项目控制台</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f5598dd3fdb5?w=2636&h=198&f=png&s=124671" alt=""></p>
<p>（4）查看rabbitmq</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f5717f0702b2?w=1808&h=738&f=png&s=93414" alt=""></p>
<p>2、接收消息</p>
<p>（1）新增接收订单队列信息的listener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderQueueListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(OrderQueueListener<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = RabbitMqKey.TRADE_ORDER_QUEUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(msg)) &#123;</span><br><span class="line">                logger.warn(<span class="string">"接收的数据为空"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(msg);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"处理接收到数据，发生异常：&#123;&#125;"</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）由于刚才我们已经发送了信息，这里只要启动项目就能接收到信息</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f5d3f7db9091?w=3356&h=636&f=png&s=336057" alt=""></p>
<h3 id="2、Work模式"><a href="#2、Work模式" class="headerlink" title="2、Work模式"></a>2、Work模式</h3><p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f63bf2d87e97?w=375&h=165&f=png&s=18461" alt=""></p>
<p>p:消息生产者（就是寄信的人）<br/><br>c1，c2:消息消费者（就是收信的人）<br/><br>红色格子: 队列（就是邮差，送信的人）<br/></p>
<p>（1）发送消息，在刚才的controller中添加一个接口，循环发送100条消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/batch/producers"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">batchProducers</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)&#123;</span><br><span class="line">        sender.orderSendQueue(<span class="string">"Hello World"</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）<font color=DeepSkyBlue>开两个服务</font>，都接收同一个队列的信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener</span>(queues = RabbitMqKey.TRADE_ORDER_QUEUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(msg)) &#123;</span><br><span class="line">                logger.warn(<span class="string">"接收的数据为空"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"服务1接收到的数据："</span> + msg);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"处理接收到数据，发生异常：&#123;&#125;"</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener</span>(queues = RabbitMqKey.TRADE_ORDER_QUEUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(msg)) &#123;</span><br><span class="line">                logger.warn(<span class="string">"接收的数据为空"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"服务2接收到的数据："</span> + msg);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"处理接收到数据，发生异常：&#123;&#125;"</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>（3）查看两个服务的结果</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f774fdf41421?w=2476&h=726&f=png&s=220685" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f77a7cc9858b?w=1738&h=696&f=png&s=161784" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">结果：有多个服务接收同一个队列的信息，MQ默认是用轮询分发的方式发送信息的！如果你想采用公平分发（能者多劳）模式的话，请看下面</span><br></pre></td></tr></table></figure>
<p>（4）修改服务1配置文件</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f86d47012a13?w=1096&h=652&f=png&s=81937" alt=""></p>
<p>（5）修改服务2配置文件</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f87a8ccdfe82?w=1340&h=622&f=png&s=76593" alt=""></p>
<p>（6）重新测试，查看结果（看下图可知服务2接收到的消息明显多于服务1收到的消息）</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f89729a689e6?w=1716&h=1090&f=png&s=251965" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f8a48bf2b653?w=2052&h=626&f=png&s=207530" alt=""></p>
<h3 id="3、订阅模式"><a href="#3、订阅模式" class="headerlink" title="3、订阅模式"></a>3、订阅模式</h3><p><img src="https://user-gold-cdn.xitu.io/2020/4/9/1715f8b5a02ac1c3?w=478&h=190&f=png&s=14537" alt=""></p>
<p>p:消息生产者（就是寄信的人）<br/><br>x:交换器（就是邮局）<br/><br>c1，c2:消息消费者（就是收信的人）<br/><br>红色格子: 队列（就是邮差，送信的人）<br/></p>
<p>一封信通过邮局邮给两个人，邮局就会派两个邮差送信给相应的人，这里就是两个不同的队列绑定同一个交换器，确保一条消息两个服务都能同时接收到。</p>
<p>rabbitmq中，Exchange 有4个类型：Direct，Topic，Fanout，Headers <br/><br>Direct Exchange：将消息中的Routing key与该Exchange关联的所有Binding中的Routing key进行比较，如果相等，则发送到该Binding对应的Queue中； <br/><br>Topic Exchange：将消息中的Routing key与该Exchange关联的所有Binding中的Routing key进行对比，如果匹配上了，则发送到该Binding对应的Queue中； <br/><br>Fanout Exchange：直接将消息转发到所有binding的对应queue中，这种exchange在路由转发的时候，忽略Routing key； <br/><br>Headers Exchange：将消息中的headers与该Exchange相关联的所有Binging中的参数进行匹配，如果匹配上了，则发送到该Binding对应的Queue中； <br/></p>
<p><strong>Direct Exchange、Topic Exchange进行Binding的时候，需要指定Routing key</strong></p>
<p><strong>Fanout Exchange、Headers Exchange进行Binding的时候，不需要指定Routing key</strong></p>
<p>1、队列绑定交换器</p>
<p>从前文可看到，我已经将订单队列和交换器绑定了（订单交换器的类型是Fanout Exchange）</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/13/171718c1486f59a9?w=1067&h=831&f=png&s=146714" alt=""></p>
<p>现在将另一个服务也绑定一下</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/13/171718ebe5b4cce6?w=783&h=339&f=png&s=50877" alt=""></p>
<p>2、查看绑定关系</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17167e86578fa14a?w=882&h=602&f=png&s=58162" alt=""></p>
<p>3、启动两个服务，发送信息至订单交换器</p>
<p>（1） 新增发送至交换器接口</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/10/171647947d66f4f2?w=1168&h=1124&f=png&s=137900" alt=""></p>
<p>（2）调用接口，执行发送</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/10/171647b496c028a4?w=1908&h=478&f=png&s=72390" alt=""></p>
<p>（3）查看两个服务结果</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17167e5a64e6d38f?w=1320&h=133&f=png&s=46243" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17167e5e3d2d9f31?w=685&h=89&f=png&s=5471" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果交换器没有绑定队列的话，那么发送到交换器的消息将会丢失，因为，交换机没有存储消息的能力，消息只能存在在队列中。</span><br></pre></td></tr></table></figure>

<h3 id="4、路由模式"><a href="#4、路由模式" class="headerlink" title="4、路由模式"></a>4、路由模式</h3><p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17167eae9800307b?w=1109&h=327&f=png&s=79066" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">路由模式跟发布订阅模式类似，然后在订阅模式的基础上加上了类型，订阅模式是分发到所有绑定到交换机的队列，路由模式只分发到绑定在交换机上面指定路由键的队列，就是按照某种规则指定发送到交换器的内容由哪些队列接收，并不一定所有绑定交换器的队列都能接收到。</span><br></pre></td></tr></table></figure>

<p>p:消息生产者（就是寄信的人）<br/><br>x:direct类型的交换器（就是邮局）<br/><br>c1，c2:消息消费者（就是收信的人）<br/><br>红色格子: 队列（就是邮差，送信的人）<br/></p>
<p>上图是一个结合日志消费级别的配图，在路由模式它会把消息路由到那些 binding key 与 routing key 完全匹配的 Queue 中，此模式也就是 Exchange 模式中的 direct 模式。</p>
<p>以上图的配置为例，我们以 routingKey=”error” 发送消息到 Exchange，则消息会路由到Queue1（amqp.gen-S9b…，这是由RabbitMQ自动生成的Queue名称）和Queue2（amqp.gen-Agl…）。如果我们以 routingKey=”info” 或 routingKey=”warning” 来发送消息，则消息只会路由到 Queue2。如果我们以其他 routingKey 发送消息，则消息不会路由到这两个 Queue 中。</p>
<p>1、新建队列、交换器以及路由并绑定</p>
<p>（1）服务1:</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/171681fd68e6505a?w=671&h=489&f=png&s=45219" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMqKey</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单-队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_ORDER_QUEUE = <span class="string">"trade-order-queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单-交换器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_ORDER_EXCHANGE = <span class="string">"trade-order-exchange"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由测试队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_DIRECT_TEST_QUEUE = <span class="string">"trade-direct-test-queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由测试交换器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_DIRECT_TEST_EXCHANGE = <span class="string">"trade-order-exchange"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY = <span class="string">"ERROR"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TradeOrderQueueConfig类中绑定关系：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/13/171719912fff7d45?w=820&h=338&f=png&s=56285" alt=""></p>
<p>（2）服务2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由测试队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_DIRECT_TEST_QUEUE_V2 = <span class="string">"trade-direct-test-queue-v2"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由测试交换器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_DIRECT_TEST_EXCHANGE = <span class="string">"trade-order-exchange"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROUTING_KEY = <span class="string">"INFO"</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/4/13/1717199b3fd2ce2a?w=742&h=339&f=png&s=55681" alt=""></p>
<p>2、查看绑定关系</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/1716841b457fd435?w=855&h=618&f=png&s=54896" alt=""></p>
<p>3、两个服务分别新建DirectListener类，接收队列信息</p>
<p>（1）服务1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DirectListener<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = RabbitMqKey.TRADE_DIRECT_TEST_QUEUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(msg)) &#123;</span><br><span class="line">                logger.warn(<span class="string">"接收的数据为空"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"服务1接收到的数据："</span> + msg);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"处理接收到数据，发生异常：&#123;&#125;"</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）服务2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DirectListener<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = RabbitMqKey.TRADE_DIRECT_TEST_QUEUE_V2)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(msg)) &#123;</span><br><span class="line">                logger.warn(<span class="string">"接收的数据为空"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"服务2接收到的数据："</span> + msg);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"处理接收到数据，发生异常：&#123;&#125;"</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、Sender类增加指定路由发送消息方法，并增加发送消息接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ERROR路由发送消息至交换器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">errorSendQueue</span><span class="params">(Object payload)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> baseSend(RabbitMqKey.TRADE_DIRECT_TEST_EXCHANGE, RabbitMqKey.ROUTING_KEY, payload, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * INFO路由发送消息至交换器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">infoSendQueue</span><span class="params">(Object payload)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> baseSend(RabbitMqKey.TRADE_DIRECT_TEST_EXCHANGE, <span class="string">"INFO"</span>, payload, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在ProducersController类中增加两个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * info</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/send/info"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sender.infoSendQueue(<span class="string">"我是info级别的日志，你可以不用管我"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * info</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/send/error"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendError</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sender.errorSendQueue(<span class="string">"我是error级别的日志，你也可以不用管我，只要你不怕死"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后重新启动一下两个服务</p>
<p>（5）调用/send/info接口，查看结果</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/1716842cdedc1203?w=1924&h=268&f=png&s=42474" alt=""></p>
<p>服务1没有接收到消息：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168435d0169584?w=1367&h=152&f=png&s=53082" alt=""></p>
<p>服务2接收到了消息：<br><img src="https://user-gold-cdn.xitu.io/2020/4/11/1716843b9d8c3127?w=757&h=101&f=png&s=6926" alt=""></p>
<p>（6）调用/send/error接口，查看结果</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/171684467709149b?w=1932&h=288&f=png&s=43952" alt=""></p>
<p>服务1:</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/1716845ebeaa8578?w=1397&h=145&f=png&s=51673" alt=""></p>
<p>服务2:</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168465a8b29e9d?w=1006&h=158&f=png&s=3948" alt=""></p>
<h3 id="5、主题模式（通配符模式）"><a href="#5、主题模式（通配符模式）" class="headerlink" title="5、主题模式（通配符模式）"></a>5、主题模式（通配符模式）</h3><p><img src="https://user-gold-cdn.xitu.io/2020/4/11/171684777b35d6f3?w=1087&h=107&f=png&s=15567" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/171686ae3908bc61?w=549&h=295&f=png&s=52074" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168479ab8366b1?w=1040&h=267&f=png&s=69803" alt=""></p>
<p>p:消息生产者（就是寄信的人）<br/><br>x:topic类型的交换器（就是邮局）<br/><br>c1，c2:消息消费者（就是收信的人）<br/><br>红色格子: 队列（就是邮差，送信的人）<br/></p>
<p>1、新建队列、交换器以及绑定关系</p>
<p>（1）服务1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由测试队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_TOPIC_TEST_QUEUE = <span class="string">"trade-topic-test-queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由测试交换器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_TOPIC_TEST_EXCHANGE = <span class="string">"trade-topic-test-exchange"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_ROUTING_KEY = <span class="string">"JAVA.#"</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/4/13/171719c400870baf?w=773&h=349&f=png&s=57454" alt=""></p>
<p>（2） 服务2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由测试队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_TOPIC_TEST_QUEUE_V2 = <span class="string">"trade-topic-test-queue-v2"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由测试交换器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_TOPIC_TEST_EXCHANGE = <span class="string">"trade-topic-test-exchange"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_ROUTING_KEY = <span class="string">"JAVA.*"</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/4/13/171719d99946425c?w=815&h=347&f=png&s=58176" alt=""></p>
<p>2、查看绑定关系</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/1716870bcae58b4e?w=845&h=596&f=png&s=50036" alt=""></p>
<p>3、两个服务分别新建TopicListener类，接收队列信息</p>
<p>（1）服务1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(TopicListener<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = RabbitMqKey.TRADE_TOPIC_TEST_QUEUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(msg)) &#123;</span><br><span class="line">                logger.warn(<span class="string">"接收的数据为空"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"服务1接收到的数据："</span> + msg);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"处理接收到数据，发生异常：&#123;&#125;"</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）服务2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(TopicListener<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = RabbitMqKey.TRADE_TOPIC_TEST_QUEUE_V2)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(msg)) &#123;</span><br><span class="line">                logger.warn(<span class="string">"接收的数据为空"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"服务2接收到的数据："</span> + msg);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"处理接收到数据，发生异常：&#123;&#125;"</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、Sender类增加指定路由发送消息方法，并增加发送消息接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息至topic类型的交换器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">topicErrorSendQueue</span><span class="params">(Object payload)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> baseSend(RabbitMqKey.TRADE_TOPIC_TEST_EXCHANGE, <span class="string">"JAVA.LOG"</span>, payload, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息至topic类型的交换器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">topicInfoSendQueue</span><span class="params">(Object payload)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> baseSend(RabbitMqKey.TRADE_TOPIC_TEST_EXCHANGE, <span class="string">"JAVA.LOG.ERROR"</span>, payload, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在ProducersController类中增加两个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/send/java"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendJava</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sender.topicErrorSendQueue(<span class="string">"JAVA.*:匹配不多不少一个词 JAVA.#:匹配一个或多个词"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/send/java/error"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendJavaError</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sender.topicInfoSendQueue(<span class="string">"JAVA.*:匹配不多不少一个词 JAVA.#:匹配一个或多个词"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>5、调用/send/java接口，查看结果（路由key为JAVA.LOG，所以两个服务都能匹配的到）</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168711b5ae4faa?w=1926&h=250&f=png&s=41016" alt=""></p>
<p>（1）服务1:</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168718a5090f21?w=1345&h=129&f=png&s=48518" alt=""></p>
<p>（2）服务2:</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/1716871c94b7aab5?w=760&h=112&f=png&s=6913" alt=""></p>
<p>6、调用/send/java/error接口，查看结果（路由key为JAVA.LOG.ERROR，所以只有JAVA.#能匹配的到）</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/1716873cbda6bd97?w=1930&h=282&f=png&s=44314" alt=""></p>
<p>（1）服务1:</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/171687425021c5f0?w=1345&h=148&f=png&s=49312" alt=""></p>
<p>（2）服务2:</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168746319283aa?w=1119&h=166&f=png&s=4505" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通配模式路由key的这里要用*.*,注意中间是点，不能换别的！</span><br></pre></td></tr></table></figure>

<h1 id="延迟队列"><a href="#延迟队列" class="headerlink" title="延迟队列"></a>延迟队列</h1><hr>
<h2 id="什么是延迟队列"><a href="#什么是延迟队列" class="headerlink" title="什么是延迟队列"></a>什么是延迟队列</h2><p>延时队列，首先，它是一种队列，队列意味着内部的元素是有序的，元素出队和入队是有方向性的，元素从一端进入，从另一端取出。</p>
<p>其次，延时队列，最重要的特性就体现在它的延时属性上，跟普通的队列不一样的是，普通队列中的元素总是等着希望被早点取出处理，而延时队列中的元素则是希望被在指定时间得到取出和处理，所以延时队列中的元素是都是带时间属性的，通常来说是需要被处理的消息或者任务。</p>
<p>简单来说，延时队列就是用来存放需要在指定时间被处理的元素的队列。</p>
<h2 id="延迟队列的使用场景"><a href="#延迟队列的使用场景" class="headerlink" title="延迟队列的使用场景"></a>延迟队列的使用场景</h2><p>（1）订单在十分钟之内未支付则自动取消。<br/><br>（2）新创建的店铺，如果在十天内都没有上传过商品，则自动发送消息提醒。<br/><br>（3）账单在一周内未支付，则自动结算。<br/><br>（4）用户注册成功后，如果三天内没有登陆则进行短信提醒。<br/><br>（5）用户发起退款，如果三天内没有得到处理则通知相关运营人员。<br/><br>（6）预定会议后，需要在预定的时间点前十分钟通知各个与会人员参加会议。<br/></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>rabbitMQ中是没有延时队列的，也没有属性可以设置，只能通过死信交换器(DLX)和设置过期时间(TTL)结合起来实现延迟队列<br/></p>
<p>1.TTL<br/><br>TTL是Time To Live的缩写, 也就是生存时间。<br/><br>RabbitMq支持对消息和队列设置TTL，对消息这设置是在发送的时候指定，对队列设置是从消息入队列开始计算, 只要超过了队列的超时时间配置, 那么消息会自动清除。<br/><br>如果两种方式一起使用消息对TTL和队列的TTL之间较小的为准，也就是消息5s过期，队列是10s，那么5s的生效。<br/><br>默认是没有过期时间的，表示消息没有过期时间；如果设置为0，表示消息在投递到消费者的时候直接被消费，否则丢弃。<br/><br>设置消息的过期时间用 x-message-ttl 参数实现，单位毫秒。<br/><br>设置队列的过期时间用 x-expires 参数，单位毫秒，注意，不能设置为0。<br/></p>
<p>2.DLX和死信队列<br/><br>DLX即Dead-Letter-Exchange(死信交换机)，它其实就是一个正常的交换机，能够与任何队列绑定。<br/><br>死信队列是指队列(正常)上的消息(过期)变成死信后，能够后发送到另外一个交换机(DLX)，然后被路由到一个队列上，<br/><br>这个队列，就是死信队列<br/><br>成为死信一般有以下几种情况：<br/><br>消息被拒绝(basic.reject or basic.nack)且带requeue=false参数<br/><br>消息的TTL-存活时间已经过期<br/><br>队列长度限制被超越(队列满)<br/></p>
<p>注1：如果队列上存在死信， RabbitMq会将死信消息投递到设置的DLX上去 ，<br/><br>注2：通过在队列里设置x-dead-letter-exchange参数来声明DLX，如果当前DLX是direct类型还要声明x-dead-letter-routing-key参数来指定路由键，如果没有指定，则使用原队列的路由键</p>
<p><font color=red>通过DLX和TTL模拟出延迟队列的功能，即:a交换器绑定a1队列，发送消息到a交换器，消息会被保存在a1队列内，而a1队列内的消息会设置过期时间，等到了过期时间还没有被消费，该消息就会发送给死信交换器b，而b和死信队列b1绑定，我们只需要消费b1里面的消息就行。</font></p>
<p>1、定义交换器及队列名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收延迟消息的队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_ORDER_DELAY_QUEUE = <span class="string">"trade-order-delay-queue"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DLX，dead letter发送到的 exchange</span></span><br><span class="line"><span class="comment">     * 接收延迟消息的队列交换器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADE_ORDER_DELAY_EXCHANGE = <span class="string">"trade-order-delay-exchange"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * routing key 名称</span></span><br><span class="line"><span class="comment">     * 具体消息发送在该 routingKey 的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ORDER_DELAY_ROUTING_KEY = <span class="string">"order-delay"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收死信消息的queue - queue</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_QUEUE = <span class="string">"dead-letter-queue"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收死信消息的exchange - exchange</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_EXCHANGE = <span class="string">"dead-letter-exchange"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * routing key 名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEAD_LETTER_ROUTING_KEY = <span class="string">"dead-letter"</span>;</span><br></pre></td></tr></table></figure>

<p>2、TradeOrderQueueConfig类初始化交换器和队列，并绑定</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168abd0127a6f5?w=987&h=795&f=png&s=117175" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168ac009cbb9c8?w=958&h=658&f=png&s=100784" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收延迟信息的队列，并指定过期时间，以及过期之后要发送到哪个死信交换器，以及死信交换器的路由</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"delayOrderQueue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">delayOrderQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// x-dead-letter-exchange 声明了当前队列绑定的死信交换机</span></span><br><span class="line">        params.put(<span class="string">"x-dead-letter-exchange"</span>, RabbitMqKey.DEAD_LETTER_EXCHANGE);</span><br><span class="line">        <span class="comment">// x-dead-letter-routing-key 声明了这些死信在转发时携带的 routing-key 名称。</span></span><br><span class="line">        params.put(<span class="string">"x-dead-letter-routing-key"</span>, RabbitMqKey.DEAD_LETTER_ROUTING_KEY);</span><br><span class="line">        <span class="comment">// x-message-ttl 队列过期时间</span></span><br><span class="line">        params.put(<span class="string">"x-message-ttl"</span>, <span class="number">100000</span>);</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(RabbitMqKey.TRADE_ORDER_DELAY_QUEUE).withArguments(params).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收延迟信息的交换器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"orderDelayExchange"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">orderDelayExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(RabbitMqKey.TRADE_ORDER_DELAY_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">Binding <span class="title">orderDelayBinding</span><span class="params">(@Qualifier(<span class="string">"delayOrderQueue"</span>)</span> Queue delayOrderQueue,</span></span><br><span class="line"><span class="function">                         @<span class="title">Qualifier</span><span class="params">(<span class="string">"orderDelayExchange"</span>)</span> DirectExchange orderDelayExchange) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayOrderQueue).to(orderDelayExchange).with(RabbitMqKey.ORDER_DELAY_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收死信队列内的信息 - queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"orderQueue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">orderQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(RabbitMqKey.DEAD_LETTER_QUEUE, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将路由键和某模式进行匹配。此时队列需要绑定要一个模式上。</span></span><br><span class="line"><span class="comment">     * 符号“#”匹配一个或多个词，符号“*”匹配不多不少一个词。因此“audit.#”能够匹配到“audit.irs.corporate”，但是“audit.*” 只会匹配到“audit.irs”。</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"orderTopicExchange"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> TopicExchange <span class="title">orderTopicExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TopicExchange(RabbitMqKey.DEAD_LETTER_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">Binding <span class="title">orderTopicBinding</span><span class="params">(@Qualifier(<span class="string">"orderQueue"</span>)</span> Queue orderQueue,</span></span><br><span class="line"><span class="function">                              @<span class="title">Qualifier</span><span class="params">(<span class="string">"orderTopicExchange"</span>)</span> TopicExchange orderTopicExchange) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(orderQueue).to(orderTopicExchange).with(RabbitMqKey.DEAD_LETTER_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>3、查看绑定信息</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168ad966e67126?w=1056&h=466&f=png&s=36098" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168adcb956f594?w=875&h=556&f=png&s=42866" alt=""></p>
<p>4、增加DelayListener类接收延迟消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DelayListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DelayListener<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收延迟消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = RabbitMqKey.DEAD_LETTER_QUEUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(msg)) &#123;</span><br><span class="line">                logger.warn(<span class="string">"接收的数据为空"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.info(<span class="string">"接收到的延迟消息：&#123;&#125;"</span>, msg);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"处理接收到数据，发生异常：&#123;&#125;"</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、增加发送延迟消息的方法和接口</p>
<p>Sender类增加发送方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送延时队列信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">delaySend</span><span class="params">(Object payload)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> baseSend(RabbitMqKey.TRADE_ORDER_DELAY_EXCHANGE, RabbitMqKey.ORDER_DELAY_ROUTING_KEY, payload, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ProducersController类增加接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/send/delay/message"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendDelayMessage</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sender.delaySend(<span class="string">"某某某订单已经失效，请归还库存"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>6、调用接口，查看结果</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168b0251ebf635?w=1910&h=312&f=png&s=48066" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168b0e2f78ce6f?w=1346&h=211&f=png&s=80519" alt=""></p>
<p><font color=red>注意：这里的过期时间设定死了是100秒，就是说你发送到这个队列的信息，都是100秒过期的，如果你的业务有些是10秒过期的，有些是1分钟过期的，你就不能用这种方式，得用一个rabbitmq的插件，<a href="https://www.cnblogs.com/mfrank/p/11260355.html" target="_blank" rel="noopener">具体内容请点击这里</a></font>。</p>
<h1 id="RabbitMq使用过程中遇到的问题及解决方案"><a href="#RabbitMq使用过程中遇到的问题及解决方案" class="headerlink" title="RabbitMq使用过程中遇到的问题及解决方案"></a>RabbitMq使用过程中遇到的问题及解决方案</h1><hr>
<p>点击查看<a href="https://www.cnblogs.com/qts-hope/p/11242559.html" target="_blank" rel="noopener">Spring Boot + RabbitMQ 配置参数解释</a></p>
<h2 id="消息重试机制"><a href="#消息重试机制" class="headerlink" title="消息重试机制"></a>消息重试机制</h2><p>如果有某一条消息消费者业务逻辑执行失败，需要重新发送mq再次消费的话，可以利用rabbitmq的重试机制，而重试的话一般都需要指定重试次数以及重试间隔时间等，不然后面的消息会无法获取，设置重复次数的话一般有以下几种做法：</p>
<p>1、使用redis或者mongo等第三方存储当前重试次数。<br/><br>2、在header中添加重试次数，并且使用channel.basicPublish() 方法重新将消息发送出去后将重试次数加1。<br/><br>3、使用spring-rabbit中自带的retry功能。<br/></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果你设置消息是手动确认的，那么第三种方式配置了是无效的，channel.basicNack(message.getMessageProperties().getDeliveryTag(), false, false);这个方法是失败确认，第三个参数就是失败之后你是否要将消息重新放回队列，如果你配置了true，将消息放回队列中，那么消息会一直重试，而不会按照配置文件中重试次数走，这样会一直阻塞后面的消息，所以手动确认的就要用第一种或者第二种方式，自己设置重复次数，达到重复次数之后将信息转发到另一个队列中记录日志等等，然后手动确认成功。</span><br></pre></td></tr></table></figure>

<p>第一种：</p>
<p>1、先测试一下上面说的内容：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716ca336fae5e9e?w=839&h=525&f=png&s=67754" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/13/17171a8df2d42feb?w=718&h=352&f=png&s=51446" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716ca3a15ae07db?w=936&h=400&f=png&s=70492" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716ca3f0186d593?w=419&h=274&f=png&s=26357" alt=""></p>
<p>配置的最大重试次数、最大重试时间、重试间隔等参数无用，消息会无限制重复。</p>
<p>2、如果一定要手动确认的话，可以看下下面图片，交换器绑定一个死信队列，在失败确认之后数据丢在死信队列，然后记录日志，人工干预：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/13/17171aac89448dec?w=784&h=509&f=png&s=91246" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716cb499490d255?w=979&h=386&f=png&s=73985" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716cb56873cdb95?w=1344&h=133&f=png&s=65949" alt=""></p>
<p>3、如果要手动确认，并且要指定重复次数，重复次数放在缓存中（会阻塞后续消息，意思就是这5次重试执行完之后才会有下个消息）：</p>
<p>（1）配置文件改为手动确认</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716d0a5bddc4b72?w=735&h=523&f=png&s=63330" alt=""></p>
<p>（2）接收类里面的方法都改成手动确认，这里缓存的key：correlation就是我们在发送消息时添加进去的唯一ID</p>
<p>correlation:</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716d21521b76325?w=1044&h=805&f=png&s=126751" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716d0bde6e67f5e?w=1186&h=915&f=png&s=169954" alt=""></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716d0cf043c196b?w=942&h=388&f=png&s=59120" alt=""></p>
<p>（3）查看结果，超过5次就进入了死信队列（到时候可以拿死信队列中的数据来记录日志或提示人工干预等）</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716d0e4cb75674e?w=1405&h=251&f=png&s=72402" alt=""></p>
<p>4、如果不想阻塞消息，想将失败的信息重新推入队列中，并且遵循先入先出原则的话请参照第二种方式</p>
<p>第二种：</p>
<p><a href="https://www.jianshu.com/p/301a31541802" target="_blank" rel="noopener">请点击这里</a>，大概思路是这样的(就是把重试的次数放在rabbitmq的头文件中，下次执行的时候你从头文件获取到信息，然后判断是否超过最大重复次数，然后进行相应处理)，代码是否能运行我没试过。</p>
<p>第三种：</p>
<p>1、增加交换器及队列名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试-队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST_QUEUE = <span class="string">"test-queue"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试-交换器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TEST_EXCHANGE = <span class="string">"test-exchange"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最大重试次数之后接收消息死信队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAY_QUEUE = <span class="string">"delay-queue"</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最大重试次数之后接收消息的交换器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAY_EXCHANGE = <span class="string">"delay-exchange"</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * routing key 名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DELAY_ROUTING_KEY = <span class="string">"delay-routing-key"</span>;</span><br></pre></td></tr></table></figure>

<p>2、绑定关系</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"testExchange"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> FanoutExchange <span class="title">testExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"exchange : &#123;&#125;"</span>, RabbitMqKey.TEST_EXCHANGE);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FanoutExchange(RabbitMqKey.TEST_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"delayTestQueue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">delayTestQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"queue : &#123;&#125;"</span>, RabbitMqKey.TEST_QUEUE);</span><br><span class="line">        <span class="comment">// 队列持久化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(RabbitMqKey.TEST_QUEUE, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">Binding <span class="title">delayTestBinding</span><span class="params">(@Qualifier(<span class="string">"delayTestQueue"</span>)</span> Queue delayTestQueue,</span></span><br><span class="line"><span class="function">                          @<span class="title">Qualifier</span><span class="params">(<span class="string">"testExchange"</span>)</span> FanoutExchange testExchange) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayTestQueue).to(testExchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"delayQueue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">delayQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"queue : &#123;&#125;"</span>, RabbitMqKey.DELAY_QUEUE);</span><br><span class="line">        <span class="comment">// 队列持久化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(RabbitMqKey.DELAY_QUEUE, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"delayExchange"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DirectExchange <span class="title">delayExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"exchange : &#123;&#125;"</span>, RabbitMqKey.DELAY_EXCHANGE);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DirectExchange(RabbitMqKey.DELAY_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">Binding <span class="title">delayBinding</span><span class="params">(@Qualifier(<span class="string">"delayQueue"</span>)</span> Queue delayQueue,</span></span><br><span class="line"><span class="function">                          @<span class="title">Qualifier</span><span class="params">(<span class="string">"delayExchange"</span>)</span> DirectExchange delayExchange) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayQueue).to(delayExchange).with(RabbitMqKey.DELAY_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/4/13/17171afbdf8d933c?w=986&h=704&f=png&s=115516" alt=""></p>
<p>3、修改配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq:</span><br><span class="line">  host: localhost</span><br><span class="line">  port: <span class="number">5672</span></span><br><span class="line">  virtual-host: /</span><br><span class="line">  username: admin</span><br><span class="line">  password:  admin</span><br><span class="line">  # 是否启用【发布确认】</span><br><span class="line">  publisher-confirms: <span class="keyword">true</span></span><br><span class="line">  # 指定一个请求能处理多少个消息</span><br><span class="line">  listener:</span><br><span class="line">    simple:</span><br><span class="line">      # 限流（海量数据，同时只能过来一条）</span><br><span class="line">      prefetch: <span class="number">1</span></span><br><span class="line">      # 自动签收auto  手动 manual  默认自动签收</span><br><span class="line">      acknowledge-mode: auto</span><br><span class="line">      retry:</span><br><span class="line">        # 开启重试机制</span><br><span class="line">        enabled: <span class="keyword">true</span></span><br><span class="line">        # 重试次数</span><br><span class="line">        max-attempts: <span class="number">5</span></span><br><span class="line">        # 最大间隔时间</span><br><span class="line">        max-interval: <span class="number">20000</span></span><br><span class="line">        # 重试间隔时间（单位毫秒）</span><br><span class="line">        initial-interval: <span class="number">3000</span></span><br><span class="line">        #乘子  重试间隔*乘子得出下次重试间隔  3s  6s  12s  24s  此处24s&gt;20s  走20s</span><br><span class="line">        multiplier: <span class="number">2</span></span><br><span class="line">        # 重试次数超过上面的设置之后是否丢弃（false不丢弃时需要写相应代码将该消息加入死信队列）</span><br><span class="line">      <span class="keyword">default</span>-requeue-rejected: <span class="keyword">false</span></span><br></pre></td></tr></table></figure>

<p>4、TestListener类增加处理队列信息的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(TestListener<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = RabbitMqKey.TEST_QUEUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Message message)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line">        String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(msg)) &#123;</span><br><span class="line">            logger.warn(<span class="string">"接收的数据为空"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(LocalDateTime.now() + <span class="string">":Subscriber:"</span> + <span class="keyword">new</span> String(message.getBody(), <span class="string">"UTF-8"</span>));</span><br><span class="line">        <span class="comment">//出现异常</span></span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> b = <span class="number">1</span> / a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收超过最大重试次数的消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = RabbitMqKey.DELAY_QUEUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process1</span><span class="params">(Message message)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String msg = <span class="keyword">new</span> String(message.getBody());</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(msg)) &#123;</span><br><span class="line">                logger.warn(<span class="string">"接收的数据为空"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"接收到的死信消息："</span> + msg);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"处理接收到数据，发生异常：&#123;&#125;"</span>, e.getMessage());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、Sender类增加发送消息方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testSendExchange</span><span class="params">(Object payload)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> baseSend(RabbitMqKey.TEST_EXCHANGE, <span class="string">""</span>, payload, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>6、ProducersController增加测试接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/send/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sender.testSendExchange(<span class="string">"测试消息重试机制"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>7、最重要的一点，RabbitAck类增加超过最大重试次数的信息转发的交换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MessageRecoverer <span class="title">messageRecoverer</span><span class="params">(RabbitTemplate rabbitTemplate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RepublishMessageRecoverer(rabbitTemplate, RabbitMqKey.DELAY_EXCHANGE, RabbitMqKey.DELAY_ROUTING_KEY);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716c92a6abaf550?w=897&h=670&f=png&s=92535" alt=""></p>
<p>如果不手动配置MessageRecoverer，会默认使用RejectAndDontRequeueRecoverer，实现仅仅是将异常打印抛出，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RejectAndDontRequeueRecoverer</span> <span class="keyword">implements</span> <span class="title">MessageRecoverer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Log logger = LogFactory.getLog(RejectAndDontRequeueRecoverer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recover</span><span class="params">(Message message, Throwable cause)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isWarnEnabled()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logger.warn(<span class="string">"Retries exhausted for message "</span> + message, cause);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> ListenerExecutionFailedException(<span class="string">"Retry Policy Exhausted"</span>, <span class="keyword">new</span> AmqpRejectAndDontRequeueException(cause), message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>8、测试，查看结果</p>
<p>（1）配置了MessageRecoverer：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716c961c02c0a9b?w=1380&h=218&f=png&s=106308" alt=""></p>
<p>（2）不配置了MessageRecoverer：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716c97e28f0425a?w=1475&h=279&f=png&s=104494" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如果不是必须保证消息的投靠特别稳定、数据不能出现一点丢失。那么完全可以不用配自动重试的机制的，毕竟网络波动这种情况还是很少见的，业务逻辑执行有问题（比如空指针，数组越界等问题）你重试一百次也是报异常，这种就只能拉个程序员出来祭天就好了。</span><br></pre></td></tr></table></figure>

<h2 id="重复消费"><a href="#重复消费" class="headerlink" title="重复消费"></a>重复消费</h2><p>在这里偷一张<a href="https://juejin.im/user/59b416065188257e671b670a" target="_blank" rel="noopener">敖丙(一位非常优秀的作者)</a>的图给大家解释一下</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/11/17168b84a1ed1f5b?w=675&h=588&f=png&s=202743" alt=""></p>
<p>用户下了单，积分服务消费失败了，申请重试，而活动系统、优惠券等服务已经消费成功了，请求重试就是要重新发送一次这个消息，那已经消费成功的服务岂不是要多次消费？这样是不行的，轻则被老大骂，重则收拾铺盖回家，更重则被老板当场打死，那我们怎么办才能避免消息的重复消费呢？</p>
<p>一般这种问题的处理方式叫做接口幂等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">幂等（idempotent、idempotence）是一个数学与计算机学概念，常见于抽象代数中。</span><br><span class="line">在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。</span><br><span class="line">幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。  例如，“setTrue()”函数就是一个幂等函数,无论多次执行，其结果都是一样的.更复杂的操作幂等保证是利用唯一交易号(流水号)实现.</span><br></pre></td></tr></table></figure>
<p>通俗意思：你在接收到MQ的时候，校验一下这个mq你是否消费过，如果消费过就不在消费了，如果没有消费过就进行消费，一般业务都是有订单号的，可以用订单号+业务场景来判断，如果存在此订单号和业务场景就不在消费了，不存在就进行消费（我现在的项目就是接收到mq，校验一下mq传过来的单号是否存在，存在则打印异常日志，不存在则消费）</p>
<h2 id="消息丢失"><a href="#消息丢失" class="headerlink" title="消息丢失"></a>消息丢失</h2><p>解决消息丢失问题有四种方法：</p>
<p>1.消息持久化（看上面的代码你就知道队列和交换器怎么持久化了）</p>
<p>2.ACK确认机制（上面也讲了）</p>
<p>3.设置集群镜像模式</p>
<p>4.消息补偿机制</p>
<p>具体的内容需要<a href="https://www.cnblogs.com/flyrock/p/8859203.html" target="_blank" rel="noopener">点击这里查看</a></p>
<p>具体解决方法还是看具体公司情况的，我公司这边是这样的，比如下单之后要扣减手续费，我们是先把手续费等接收下单成功mq之后记下来，然后晚上统一划转的，不实时划转主要是考虑到金额小数点问题，因为要按一定比例分给好几个账户，一次划转总比多次好，所以我们在定时任务划转金额的时候会按订单表数据校验当天所有订单，看是否有订单成功但是mq信息丢失的情况，如果有就自动补录手续费进去，当然这只是我们公司的处理方法，可能不太成熟，具体处理信息丢失问题还是看你们公司具体的情况再定！</p>
<h2 id="顺序消费"><a href="#顺序消费" class="headerlink" title="顺序消费"></a>顺序消费</h2><p>这里的顺序消费是指消费者的顺序消费，rabbitmq队列中只是存放了发布方的顺序消息，但是消费者是否是顺序消费又是一回事</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716d22cb98cfb27?w=561&h=327&f=png&s=109217" alt=""></p>
<p>如上图，两者的结果是不是完全不一样了</p>
<p>解决方案：</p>
<p>一个Queue对应一下Consumer(消费者)，把需要保证顺序的message都发送到一个queue当中，开启手动确认，设置prefetchCount=1，每次只消费一条信息，处理过后进行手工ack，然后接收下一条message，只是由一个Consumer进行处理</p>
<p><font color=red>这里说一下，如果还是多个Consumer，使用同步处理，手工ack是不行的，第一时间每个Consumer都会收到message（如果message数量&gt;consumer数量），剩余的message才会等到ack之后发送过来，所以还是无法保证顺序消费，如下图</font></p>
<p><img src="https://user-gold-cdn.xitu.io/2020/4/12/1716d4e213332f33?w=1200&h=418&f=png&s=211004" alt=""></p>
<p>按照我的想法来说，队列本来就是先进先出的，A提供者推送新增、修改、删除三条消息入队列，那么B消费者接收到的也应该是新增、修改、删除，由于是手动确认机制，B在接收到新增之后，执行成功才会手动确认，才会接收到修改，然后再接收到删除消息，这样也是保证了顺序（我不知道我这个理论有没有什么问题，如果你们知道有啥问题请评论告诉我一下，我改下，我也百度了一些，但是基本上都是同一个思路的）</p>
<p><a href="https://www.cnblogs.com/huigelaile/p/10928984.html" target="_blank" rel="noopener">这里有个文章，关于顺序消费的，有需要的可以看下！</a></p>
<hr>
<p>本文章源码（服务1的，可能会有点乱，如果大家有什么问题可以评论，我看到会及时回应的）<a href="https://github.com/weiwanx/spring-cloud-combination" target="_blank" rel="noopener">在这里</a>，这个项目也是前几天刚弄的，只需要本地安装一个rabbitmq即可运行，以后会持续增加springcloud相关组件以及一些中间件的使用方式的！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">跑路跑路，有缘下篇文章再见，还没点赞的童鞋记得点个赞哈！</span><br></pre></td></tr></table></figure>


      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/rabbitmq/" rel="tag"># rabbitmq</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/29/MYSQL%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9-%E5%BC%95%E6%93%8E%E3%80%81%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E3%80%81%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" rel="prev" title="MYSQL相关内容(引擎、隔离级别、实现原理)">
                MYSQL相关内容(引擎、隔离级别、实现原理) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="wanxi" />
            
              <p class="site-author-name" itemprop="name">wanxi</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/weiwanx" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/qq_35364594" target="_blank" title="csdn">
                      
                        <i class="fa fa-fw fa-crosshairs"></i>csdn</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/5ddbaddd6fb9a07aad3827a8/posts" target="_blank" title="掘金">
                      
                        <i class="fa fa-fw fa-spinner"></i>掘金</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="weiwanx@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Mac下RabbitMq的安装（windows安装点这里）"><span class="nav-number">1.</span> <span class="nav-text">Mac下RabbitMq的安装（windows安装点这里）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Homebrew"><span class="nav-number">1.1.</span> <span class="nav-text">安装Homebrew</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#注意事项"><span class="nav-number">1.1.1.</span> <span class="nav-text">注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装RabbitMq"><span class="nav-number">1.2.</span> <span class="nav-text">安装RabbitMq</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动RabbitMq"><span class="nav-number">1.3.</span> <span class="nav-text">启动RabbitMq</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加用户及授权"><span class="nav-number">1.4.</span> <span class="nav-text">添加用户及授权</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加用户"><span class="nav-number">1.4.1.</span> <span class="nav-text">添加用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#授权"><span class="nav-number">1.4.2.</span> <span class="nav-text">授权</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringBoot项目中RabbitMq的使用"><span class="nav-number">2.</span> <span class="nav-text">SpringBoot项目中RabbitMq的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置项目"><span class="nav-number">2.1.</span> <span class="nav-text">配置项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加依赖"><span class="nav-number">2.1.1.</span> <span class="nav-text">添加依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改配置文件"><span class="nav-number">2.1.2.</span> <span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#项目下新建rabbit包，内容可直接复制粘贴过去"><span class="nav-number">2.1.3.</span> <span class="nav-text">项目下新建rabbit包，内容可直接复制粘贴过去</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实践"><span class="nav-number">2.2.</span> <span class="nav-text">实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、简单队列"><span class="nav-number">2.2.1.</span> <span class="nav-text">1、简单队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、Work模式"><span class="nav-number">2.2.2.</span> <span class="nav-text">2、Work模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、订阅模式"><span class="nav-number">2.2.3.</span> <span class="nav-text">3、订阅模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、路由模式"><span class="nav-number">2.2.4.</span> <span class="nav-text">4、路由模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5、主题模式（通配符模式）"><span class="nav-number">2.2.5.</span> <span class="nav-text">5、主题模式（通配符模式）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#延迟队列"><span class="nav-number">3.</span> <span class="nav-text">延迟队列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是延迟队列"><span class="nav-number">3.1.</span> <span class="nav-text">什么是延迟队列</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#延迟队列的使用场景"><span class="nav-number">3.2.</span> <span class="nav-text">延迟队列的使用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现"><span class="nav-number">3.3.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RabbitMq使用过程中遇到的问题及解决方案"><span class="nav-number">4.</span> <span class="nav-text">RabbitMq使用过程中遇到的问题及解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#消息重试机制"><span class="nav-number">4.1.</span> <span class="nav-text">消息重试机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重复消费"><span class="nav-number">4.2.</span> <span class="nav-text">重复消费</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息丢失"><span class="nav-number">4.3.</span> <span class="nav-text">消息丢失</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#顺序消费"><span class="nav-number">4.4.</span> <span class="nav-text">顺序消费</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wanxi</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>


<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
